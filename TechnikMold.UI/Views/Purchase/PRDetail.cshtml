@model TechnikSys.MoldManager.Domain.Entity.PurchaseRequest
@using MoldManager.WebUI.Models.Helpers
@{
    string UserID = "";
    string UserName = "";
    try
    {
        UserID = Request.Cookies["User"]["UserID"];
        UserName = HttpUtility.UrlDecode(Request.Cookies["User"]["FullName"], System.Text.Encoding.UTF8);
    }
    catch
    {
        UserID = "";
        UserName = "";
    }

    int DeptID;
    int PosID;
    try
    {
        DeptID = Convert.ToInt32(Request.Cookies["User"]["Department"]);
    }
    catch
    {
        DeptID = 0;
    }

    try
    {
        PosID = Convert.ToInt32(Request.Cookies["User"]["Position"]);
    }
    catch
    {
        PosID = 0;
    }
}
<style>
     #modal_tb_PurchaseItemFiles td {
            text-align: center;
            padding: 0px !important;
        }
</style>

<div>
    <input type="hidden" value="@ViewBag.TaskType" id="TaskType" />
    @if (ViewBag.PurchaseRequestID != 0)
    {
        <input type="hidden" id="PRModified" value="false" />
    }
    else
    {
        <input type="hidden" id="PRModified" value="true" />
    }
    <input type="hidden" id="tempID" value="-1" />
    <input type="hidden" id="parentPurType" value="0" />
    <input type="hidden" id="row" />
    <input type="hidden" name="PurchaseTypeID" id="PurchaseTypeID" value="@ViewBag.PurchaseTypeID" />
    <input type="hidden" id="PurchaseRequestID" value="@ViewBag.PurchaseRequestID" />
</div>
<div style="margin-top:60px">
    <h2>采购申请单 @ViewBag.RequestNumber</h2>
</div>
<div class="Form_FatherDiv">
    <div class="Form_ToolbarDiv" style="height:40px;">
        <table>
            <tr>
                @if (Model == null)
            {
                    <td><button class="btn btn-success" id="CreatePR"><span class="glyphicon glyphicon-download-alt"></span> 保存申请单</button></td>
                    <td><button class="btn btn-info" id="AddContent" disabled><span class="glyphicon glyphicon-plus"></span> 添加零件</button></td>
                    <td><button class="btn btn-danger" id="DeleteContent"><span class="glyphicon glyphicon-trash"></span> 删除零件</button></td>
                }
                else
                {
                    switch (Model.State)
                    {
                        case (int)PurchaseRequestStatus.新建:
                            if (Model.DepartmentID == DeptID)
                            {
                                <td><button class="btn btn-success" id="CreatePR"><span class="glyphicon glyphicon-download-alt"></span> 保存申请单</button></td>
                                <td><button class="btn btn-info" id="AddContent"><span class="glyphicon glyphicon-plus"></span> 添加零件</button></td>
                                <td><button class="btn btn-warning" id="DeleteContent"><span class="glyphicon glyphicon-trash"></span> 删除零件</button></td>
                                <td><button class="btn btn-warning" id="SubmitPR"><span class="glyphicon glyphicon-lock"></span> 提交申请单</button></td>
                                <td><button class="btn btn-info sinno" id="ShowAttachFileModal" style="display:none;"><span class="glyphicon glyphicon-paperclip"></span> 添加附件</button></td>
                                <td><button class="btn btn-danger" id="CancelPR"><span class="glyphicon glyphicon-ban-circle"></span> 取消申请单</button></td>
                            }

                            break;
                        case (int)PurchaseRequestStatus.待审批:
                            if (PosID > 1)
                            {
                                <td><button class="btn btn-warning" id="ReviewPR"><span class="glyphicon glyphicon-lock"></span> 审批</button></td>
                            }
                            break;
                        case (int)PurchaseRequestStatus.审批通过:
                            <td><button class="btn btn-info sinno" id="ShowAttachFileModal" style="display:none;"><span class="glyphicon glyphicon-paperclip"></span> 添加附件</button></td>
                            <td class="hr" style="display:none;"><button class="btn btn-success" id="GetERPID"><span class="glyphicon glyphicon-refresh"></span> 同步ERP料号</button></td>
                            if (DeptID == 4)
                            {
                                <td><button class="btn btn-info sinno" id="CreateQR" style="display:none;"><span class="glyphicon glyphicon-earphone"></span> 开始询价</button></td>

                            }
                            if (Model.DepartmentID == DeptID)
                            {
                                <td><button class="btn btn-warning" id="RemoveCancel"><span class="glyphicon glyphicon-move"></span> 移除订单取消项</button></td>
                            }
                            <td style="display:none;"><button class="btn btn-danger" id="PRSyncFlagBtn">已同步状态标记</button></td>
                            break;
                        case (int)PurchaseRequestStatus.完成:
                            break;
                        case (int)PurchaseRequestStatus.拒绝:
                            if (Model.DepartmentID == DeptID)
                            {
                                <td><button class="btn btn-success" id="RestartPR"><span class="glyphicon glyphicon-retweet"></span> 重启申请单</button></td>
                            }
                            break;
                    }
                    <td><button class="btn btn-primary" id="PRHistory"><span class="glyphicon glyphicon-log-out"></span> 申请单历史</button></td>
                }
            </tr>
        </table>
    </div>
    <div class="Form_HeadDiv">
        <table class="Form_HeadTable">
            <colgroup>
                <col width="5%" />
                <col width="20%" />
                <col width="5%" />
                <col width="20%" />
                <col width="5%" />
                <col width="20%" />
                <col width="5%" />
                <col width="20%" />
            </colgroup>
            @if (ViewBag.PurchaseRequestID != 0)
            {
                string status = Enum.GetName(typeof(PurchaseRequestStatus), Model.State);
                <tr>
                    <td class="headTb_label">
                        采购类型
                    </td>
                    <td><input type="text" class="form-control" id="PurchaseTypeName" value="@ViewBag.PurchaseType" disabled /></td>
                    <td class="headTb_label">供应商</td>
                    <td>
                        @if (Model.State == 1)
                        {
                            <input id="SupplierName" list="SupplierIDD" type="text" name="SupplierName" class="form-control" readonly />
                            <datalist id="SupplierIDD"></datalist>
                            <input id="SupplierID" hidden>
                        }
                        else
                        {
                            <input type="text" id="RecommandSupplierName" class="form-control" readonly />
                            <input type="hidden" id="SupplierID" name="SupplierID" value="0" />
                        }
                    </td>

                    <td class="headTb_label">
                        状态
                    </td>
                    <td>
                        <input type="text" id="PurchaseRequestStatus" class="form-control" value="@status" readonly>
                    </td>
                    <td class="headTb_label">
                        创建人
                    </td>
                    <td>
                        <input type="text" id="CreUser" class="form-control" value="@ViewBag.CreUserName" readonly />
                    </td>
                </tr>
                if (ViewBag.State < (int)PurchaseRequestStatus.待审批 && ViewBag.State >= (int)PurchaseRequestStatus.新建)
                {
                    <tr>
                        <td class="headTb_label hr" style="display:none;">申请人</td>
                        <td class="hr" style="display:none;">
                            @if (Model.State == (int)PurchaseRequestStatus.新建)
                            {
                                <select id="ApprovalUserID" class="form-control" name="ApprovalERPUserID">
                                    <option value="0">-</option>
                                    @foreach (var ApprovalUser in ViewBag.ApprovalUserIDList)
                                    {
                                        if (ViewBag.ApprovalUserName == ApprovalUser.FullName)
                                        {
                                            <option value="@ApprovalUser.UserCode" selected>@ViewBag.ApprovalUserName</option>
                                        }
                                        else
                                        {
                                            <option value="@ApprovalUser.UserCode">@ApprovalUser.FullName</option>
                                        }
                                    }
                                </select>
                            }
                            else
                            {
                                <input id="ApprovalUserID" name="ApprovalERPUserID" class="form-control" value="@ViewBag.ApprovalUserName" readonly />
                            }
                        </td>
                        <td class="headTb_label">归属部门</td>
                        <td>
                            <select id="CostCenterID" class="form-control"></select>
                        </td>
                        <td class="headTb_label">
                            需求日期
                        </td>
                        <td>
                            <input type="date" class="form-control" id="RequireDateVal" />
                        </td>
                        <td class="headTb_label">
                            申请单号
                        </td>
                        <td>
                            <input type="text" id="PurchaseRequestNumber" class="form-control" value="" readonly />
                            
                        </td>
                    </tr>
                }
                <tr>
                    <td class="headTb_label">
                        备注信息
                    </td>
                    <td colspan="7">
                        @if (@ViewBag.State < (int)PurchaseRequestStatus.待审批)
                        {
                            <input type="text" id="PRMemo" value="@Model.Memo" class="form-control"/>
                        }
                        else
                        {
                            <input type="text" id="PRMemo" value="@Model.Memo" class="form-control" readonly />
                        }
                    </td>
                </tr>
            }
            else
            {
                <tr>
                    <td class="headTb_label">
                        采购类型
                    </td>
                    <td>
                        <select id="PurchaseType" class="form-control" name="PurchaseType"></select>
                        <input type="hidden" id="PurchaseTypeName" readonly />
                    </td>
                    <td class="headTb_label">
                        供应商
                    </td>
                    <td>
                        <input id="SupplierName" list="SupplierIDD" type="text" name="SupplierName" class="form-control"  disabled />
                        <datalist id="SupplierIDD"></datalist>
                        <input id="SupplierID" hidden>
                    </td>
                    <td class="headTb_label">状态</td>
                    <td>
                        <input type="text" id="PurchaseRequestStatus" class="form-control" value="新建" readonly>
                    </td>
                </tr>
                    <tr>
                        <td class="headTb_label hr" style="display:none;">
                            申请人
                        </td>
                        <td class="hr" style="display:none;">
                            <select id="ApprovalUserID" class="form-control" name="ApprovalERPUserID">
                                <option value="0">-</option>
                                @foreach (var ApprovalUser in ViewBag.ApprovalUserIDList)
                                {
                                    <option value="@ApprovalUser.UserCode">@ApprovalUser.FullName</option>
                                }
                            </select>
                        </td>
                        <td class="headTb_label">
                            归属部门
                        </td>
                        <td>
                            <select id="CostCenterID" class="form-control"></select>
                        </td>
                        <td class="headTb_label">
                            需求日期
                        </td>
                        <td>
                            <input type="date" class="form-control" id="RequireDateVal"/>
                        </td>
                    </tr>
                    <tr>
                        <td class="headTb_label">
                            备注
                        </td>
                        <td colspan="7"><input type="text" id="PRMemo" value="" class="form-control"/></td>
                    </tr>
            }
        </table>
    </div>
    <div class="Form_TableDiv">
        <table id="PRContentGrid"></table>
        <div id="jqGridPager"></div>
    </div>
</div>

@*手工添加/编辑采购项信息对话框*@
<div class="modal" id="PRContentAdd" tabindex="-1" role="dialog" aria-labelledby="PRContentAddLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 class="modal-title" id="PRContentAddLabel">添加零件</h4>
            </div>
            <div class="modal-body">
                <table class="table-striped col-sm-12">
                    <tr>
                        <td class="col-sm-4 ">
                            <div class="_selPart1">模号</div>
                            <div class="_selPart2">耗材类型</div>
                            <div class="_selPart5">备库大类</div>
                        </td>
                        <td class="col-sm-8">
                            <div class="_selPart1">
                                <input type="text" class="form-control required" name="MoldNum" id="MoldNum" min="0" value="" placeholder="请输入模号" list="modal_MoldNum"/>
                                <datalist id="modal_MoldNum"></datalist>
                            </div>
                            <div class="_selPart2">
                                <input type="text" list="modal_HCClassList" class="form-control required" name="HCClass" id="HCClass" />
                                <datalist id="modal_HCClassList"></datalist>
                            </div> 
                            <div class="_selPart5">
                                <input type="text" list="modal_BKClassList" class="form-control required" name="BKClass" id="BKClass" />
                                <datalist id="modal_BKClassList"></datalist>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">零件号</td>
                        <td class="col-sm-8">
                            <input type="hidden" class="form-control" name="PartNumber" id="PartNumber" min="0" value="" />
                            <input type="text" list="modal_JobNoList" class="form-control required" name="JobNo" id="JobNo" min="0" value="" placeholder="请输入JOB NO" readonly/>
                            <datalist id="modal_JobNoList"></datalist>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">零件短名</td>
                        <td class="col-sm-8">
                            <input type="text" class="form-control required" name="Name" id="Name" maxlength="50" placeholder="请输入零件短名" />
                            <input type="hidden" id="PRContentID" value="0" />
                            <input type="text" id="PartID" value="0" hidden/>
                            <input type="hidden" id="MoldNumber" value="" />
                            <input type="hidden" id="VerifyFail" value="0" />
                            <input type="hidden" id="State" value="" />
                            <input type="hidden" id="ViewType" value="" />
                        </td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">数量</td>
                        <td class="col-sm-8"><input type="number" class="form-control required" name="Quantity" id="Quantity" min="0" value="" /></td>
                    </tr>
                    <tr id="tr_PlanQty" hidden>
                        <td class="col-sm-4">计划数量</td>
                        <td class="col-sm-8"><input type="number" class="form-control required" name="PlanQty" id="PlanQty" min="0" value="" hidden/></td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">规格</td>
                        <td class="col-sm-8"><input type="text" class="form-control required" name="Specification" id="Specification" maxlength="100" placeholder="请输入规格或尺寸" /></td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">材料</td>
                        <td class="col-sm-8">
                            <select class="form-control required" id="MaterialID" name="MaterialID">
                                <option value="0">-</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">硬度</td>
                        <td class="col-sm-8">
                            <select class="form-control" id="HardnessID" name="Hardness">
                                <option value="0">-</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="brandtr" >
                        <td class="col-sm-4">品牌</td>
                        <td class="col-sm-8">
                            <select class="form-control required" id="Brand" name="BrandID"></select>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">供应商</td>
                        <td class="col-sm-8">
                            <input id="AvailableSuppliers" list="modal_SupplierIDD" type="text" name="AvailableSuppliers" class="form-control" />
                            <datalist id="modal_SupplierIDD"></datalist>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">备注</td>
                        <td class="col-sm-8">
                            <input type="text" class="form-control" name="Memo" id="Memo" maxlength="99" />
                        </td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">需求日期</td>
                        <td class="col-sm-8">
                            <input type="date" class="form-control" name="RequireDate" id="RequireDate" value="" />
                        </td>
                    </tr>
                    @*<tr>
                            <td class="col-sm-4">成本归属</td>
                            <td class="col-sm-8">
                                <select class="form-control" name="CostCenterID" id="CostCenterID"></select>
                            </td>
                        </tr>*@
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
                <button type="button" id="SaveContent" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>
</div>

@*申请单提交*@
<div class="modal" id="PRSubmitModal" tabindex="-1" role="dialog" aria-labelledby="PRSubmitModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 class="modal-title" id="PRPRAcceptModalLabel">申请单提交</h4>
            </div>
            <div class="modal-body">
                <table>
                    <tr>
                        <td class="headTb_label"><label>备注</label></td>
                    </tr>
                    <tr>
                        <td class="col-sm-4">
                            <textarea id="SubmitMemo" class="form-control" rows="5" style="resize:none" maxlength="99"></textarea>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="PRSubmitButton">确定</button>
            </div>
        </div>
    </div>
</div>

@*申请单接受/拒绝*@
<div class="modal" id="PRReviewModal" tabindex="-1" role="dialog" aria-labelledby="PRReviewModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
            </div>
            <div class="modal-body">
                <table style="width:100%;text-align:center;margin:0px;padding:0px;">
                    <colgroup>
                        <col width="20%" /><col width="40%" /><col width="40%" />
                    </colgroup>
                    <tr>
                        <td style="font-weight:bold;float:left;">
                            审核结果
                            <input type="hidden" id="ReviewResponse" value="10"/>
                        </td>
                        <td style="color:green;"><input id="whchk_ok" name="approvalRadio" checked="checked" type="radio" /> 通过</td>
                        <td style="color:red;"><input id="whchk_ng" name="approvalRadio" type="radio" /> 拒绝</td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;float:left;">备注</td>
                        <td colspan="2"><textarea id="ReviewMemo" class="form-control" rows="5" style="resize:none" maxlength="99"></textarea></td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
                <button type="button" class="btn btn-warning" data-dismiss="modal" id="PRReviewButton"><span class="glyphicon glyphicon-check"></span> 确定</button>
            </div>
        </div>
    </div>
</div>

@*重启申请单对话框*@
<div class="modal" id="RestartPRDialog" tabindex="-1" role="dialog" aria-labelledby="RestartPRLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
            </div>
            <div class="modal-body" style="height:300px">
                <h4>重启原因</h4>
                <textarea id="RestartMemo" name="Memo" rows="10" class="form-control" maxlength="99" style="resize:none"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
                <button type="button" id="RestartPRBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>

@*申请单历史显示*@
<div class="modal" id="PRHistoryModal" tabindex="-1" role="dialog" aria-labelledby="PRHistoryLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 class="modal-title" id="PRHistoryLabel">申请单历史</h4>
            </div>
            <div class="modal-body">
                <select id="PRHistoryList" class="form-control" size="20"></select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
            </div>
        </div>
    </div>
</div>

@*添加零件*@
<div class="modal" id="PartSearch" tabindex="-1" role="dialog" aria-labelledby="RequireDateLabel">
    <div class="modal-dialog" style="width:800px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 class="modal-title" id="RequireDateLabel">零件查询</h4>
            </div>
            <div class="modal-body">
                <table>
                    <tr>
                        <td>
                            @*<select id="_selPartModal" class="form-control" style="width:140px;position:relative;">
                                <option value="1">模具直接材料</option>
                                <option value="2">模具生产耗材</option>
                                <option value="5">模具耗材备库</option>
                            </select>*@
                            <input id="_selPartModalTxt" class="form-control" style="width:140px" value="" readonly/>
                            <input id="_selPartModal" value="0" hidden />
                        </td>
                        <td>
                            <div class="input-group" style="float:right;">
                                <div class="input-group-btn">
                                    <label>查询关键字：</label>
                                    <select id="_sel" class="form-control" style="width:120px;position:relative;">
                                        <option value="2">物料编号</option>
                                        <option value="1">零件短名</option>
                                        <option value="3">规格</option>
                                    </select>
                                    <input type="text" class="form-control" id="SpecKeyword" placeholder="请键入搜索关键字" style="width:140px;"/>
                                    <button class="btn btn-default" id="PartSearchBtn"><span class="glyphicon glyphicon-search"></span>查询</button>
                                    <button class="btn btn-primary" id="modal_AddPart"><span class="glyphicon glyphicon-share-alt"></span>添加至表格</button>
                                </div>          
                            </div>                           
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <table class="table-striped col-sm-12" id="tb_PartSearch"></table>
                        </td>
                    </tr>
                </table>                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove-sign"></span>返回</button>
                <button type="button" class="btn btn-success" id="NewPart"><span class="glyphicon glyphicon-plus-sign"></span>新建采购项</button>
            </div>
        </div>
    </div>
</div>

@*附件*@
<div class="modal" id="PurchaseItemFileDialog" tabindex="-1" role="dialog">
    <div class="modal-dialog" style="width:950px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h4 class="modal-title">采购项附件</h4>
            </div>
            <div class="modal-body">
                <form id="modal_PurchaseItemAttachForm" name="modal_PurchaseItemAttachForm" method="post" enctype="multipart/form-data">
                    <input id="ObjID" name="ObjID" hidden />
                    <input id="ObjType" name="ObjType" value="PurchaseItems" hidden />
                    <input id="FolderName" name="FolderName" value="@ViewBag.RequestNumber" hidden/>
                    <input id="_itemIDs" name="_itemIDs" hidden />
                    <table>
                        <tr>                          
                            <td>
                                <select id="modal_sel_purFileModal" name="purFileModal" class="form-control">
                                    <option value="1">单附件模式</option>
                                    <option value="2">多附件模式</option>
                                </select>
                            </td>                            
                            <td>
                                <input id="Files" name="Files" type="file" class="form-control">
                            </td>
                            <td>
                                <button id="modal_PurchaseItemAttachSubmitbtn" class="btn btn-warning" type="button" style="width: 72px;"><span class="glyphicon glyphicon-upload"></span> 提交</button>
                            </td>
                            @*<td>
                                <a href="#" title="(多附件模式)附件名包含 '模具号'或'零件名' 即可与采购项匹配" class="form-control btn-info"><span id="modal_purFileHelper" class="glyphicon glyphicon-question-sign"></span></a>
                            </td>*@
                        </tr>
                    </table>
                    <table id="modal_tb_PurchaseItemFiles"></table>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
            </div>
        </div>
    </div>
</div>

@using (Html.BeginForm("PDFTest", "Purchase", FormMethod.Post, new { id = "PDF" }))
{ <input type="hidden" id="PDFContent" name="Content" />
}

@if (ViewBag.ProjectID == 0)
{
    Html.RenderAction("MoldSelect", "Dialog");
}

<script src="~/Scripts/Purchase.js"></script>

<script>
    $(document).ready(function(){
        InitialView();

        $(window).resize(function () {
            InitialView();
            $("#PRContentGrid").setGridWidth($('.Form_TableDiv').eq(0).width());
            $("#PRContentGrid").setGridHeight($('.Form_TableDiv').eq(0).height() - 40);
        });

        $('#whchk_ok').on('change',function(){
            approRadioChange();
        })
        $('#whchk_ng').on('change',function(){
            approRadioChange();
        })
    })
    function approRadioChange(){
        var okres = $('#whchk_ok')[0].checked;
        var ngres = $('#whchk_ng')[0].checked;
        if(okres){
            $('#ReviewResponse').val('10');
        }else if(ngres){
            $('#ReviewResponse').val('-99');
        }
    }
</script>

<script type="text/javascript">
    $(document).ready(function () {
        LoadMaterials();
        LoadSuppliers(0,1);
        LoadCostCenters();
        GetPurchaseType();
        PartSearchGrid();

        if(sessionStorage['SpecKey']!=null){
            if(sessionStorage['SpecKey']=='hr'){
                $('#btntest').hide();
            }
        }
        //_hrConfig();
        //LoadWSUser($('#TaskType').val());
        var _supplierID;
        @try{
            @:_supplierID=@Model.SupplierID
        }
        catch
        {
            @:_supplierID=-1;
                                                        }
        //LoadRecommandSuppliers(_supplierID);
        @if (ViewBag.PurchaseRequestID != 0)
        {
            @:PRContentGrid("", @ViewBag.PurchaseRequestID, @ViewBag.PRState,"","");
                                                                                            @:LoadProject(@ViewBag.ProjectID);
                                                                                            @:LoadPR(@ViewBag.PurchaseRequestID);
                                                            if (Model.SupplierID != 0)
            {
            @:LoadAssignedSupplier(@Model.SupplierID);
                                                                                             }
            @:LoadUser(@Model.UserID, "UserName");
                                                        }
        else if (ViewBag.PartIDs!="")
        {
            @:PRContentGrid("@ViewBag.PartIDs", 0, 0,"","");
                                                                                            if (ViewBag.ProjectID != 0)
            {
                @:LoadProject(@ViewBag.ProjectID);
                                                                                             }
        }
        else if (ViewBag.TaskIDs != "")
        {
            @:PRContentGrid("", 0, 0,"@ViewBag.TaskIDs","");
                                                                        }
        else if (ViewBag.WarehouseStockID != "") {
            @:PRContentGrid("",0,0,"","@ViewBag.WarehouseStockIDs");
                                                                }
        else
        {
            @:PRContentGrid("", 0, 0,"","","");
                                                                                                }
        //设置成本中心
        $('#CostCenterID').on('change',function(){
            SetCostCenter();
        })
        //设置需求日期
        $('#RequireDateVal').on('change',function(){
            SaveRequireDate( $("#RequireDateVal").val());
        })

        $("#SelectProject").on("click", function(){
            GetProjectID($("#MoldList option:selected").val());
        })

        $("#MoldList").on("dblclick", function(){
            GetProjectID($("#MoldList option:selected").val());
        })

        $("#PartNumber").on("change", function(){
            if ($("#PartNumber").val()!=""){
                VerifyMoldNumber($("#PartNumber").val(), $("#PurchaseType").val());
            }
        })

        $("#RequireDateSet").on("click", function(){
            ShowRequireDateSet();
        })

        $("#SaveRequireDateBtn").on("click", function(){
            SaveRequireDate( $("#RequireDateVal").val());
            $("#RequireDateModal").modal("hide");
        })

        $("#PurchaseType").on("change", function(){
            $('#SupplierName').attr('disabled','disabled');
            //$('#SupplierName').val('');
            //if(Number($('#PurchaseType').val())==0){               
            //    $('#SupplierName').val('');
            //}    
            SetPurchaseType();
            $.get('/Purchase/GetPurchaseTypeInfo?PurchaseTypeID='+$('#PurchaseType').val(),function(res){
                if(res.ParentTypeID==0){
                    $("#PurchaseType").val('');
                }
                else{
                    SetDefaultDate();
                }
                if(res.ParentTypeID>0){
                    $('#SupplierName').removeAttr('disabled');
                }
                //if(res.ParentTypeID==3){

                //}else{

                //}
            })            
        })

        $("#PartSearchBtn").on("click", function(){           
            PartSearch();
        })

        $("#NewPart").on("click", function(){
            NewPart();
        })

        $("#RemoveCancel").on("click", function(){
            RemoveCancelItems();
        })

        if(@ViewBag.PurchaseRequestID!=0){
            var prID=$('#PurchaseRequestID').val();
            $.ajax({
                url:"/Purchase/IsErpPasrts?prID="+prID,
                type:"Get",
                success:function(result){
                    if(result!='ok'){
                        return
                    }
                    else{
                        $('#GetERPID').css('pointer-events', 'none');
                        $('#GetERPID').css('cursor', 'not-allowed');
                        $('#GetERPID').css('background-color', 'darkgray');
                        $('#GetERPID').css('border-color', 'darkgray');
                    }
                }
            })
        }

        SupplierListImport('SupplierIDD');
        SupplierListImport('modal_SupplierIDD');

        $("#SupplierName").on('change', function(){
            SetSupplier();
            GetSupplierID($('#SupplierName').val());
        })

        $('#modal_AddPart').on('click',function(){
            AddPartNormal();
        });

        _wfViewConfig($('#TaskType').val());

        if (sessionStorage['SpecKey'] != null) {
            if (sessionStorage['SpecKey'] == 'hr') {
                $("#PRContentGrid").setGridParam().showHideCol("ERPPartID");
            }
        }
    });


    function GetProjectID(MoldNumber){
        var _url ="/Project/GetProjectID?MoldNumber="+MoldNumber;

        $.ajax({
            url:_url,
            type:"Get",
            success:function(msg){
                $("#ProjectID").val(msg);
            }
        })
    }

    function GetPurchaseType(){
        var _url="";
        if ('@ViewBag.PartIDs' != "" || sessionStorage['SpecKey'] == 'hr')
        {
            _url = "/Purchase/JsonPurchaseTypes?TypeName=模具直接材料&ContainParent=false&QFDep=true";
                                                                        }
        else if ('@ViewBag.TaskIDs' !="")
        {
            _url = "/Purchase/JsonPurchaseTypes?TypeName=模具委外加工&ContainParent=false&QFDep=true";
        }
        else
        {
            _url = "/Purchase/JsonPurchaseTypes?ContainParent=true&QFDep=true";
                                                        }
        if (_url!=""){
            
            $.getJSON(_url, function(msg){
                $("#PurchaseType").append($("<option/>", {value:0,text:"-"}))
                $.each(msg, function(i,n){
                    if (@ViewBag.TaskType==n.TaskType && @ViewBag.TaskType!=0){
                        $("#PurchaseType").append($("<option/>", {value:n.PurchaseTypeID,text:n.Name, selected:true}));
                        $('#PurchaseType').attr('disabled','disabled');
                        console.log('采购类型 ' +$('#PurchaseType').val());
                    }else{
                        if(n.ParentTypeID==0){
                            $("#PurchaseType").append(
                                //$("<option/>", {
                                //    value:0,
                                //    text:'----'+n.Name+'----',
                                //})
                                '<option value=0 disabled>----'+n.Name+'----</option>'
                                );
                        }
                        else{
                            $("#PurchaseType").append(
                                $("<option/>", {
                                    value:n.PurchaseTypeID,
                                    text:n.Name
                                }));
                        }
                    }
                });
            })
        }
    }

    function VerifyMoldNumber(PartNumber, PurchaseType){
        if (PartNumber.length==9){
            if (PurchaseType!=2){
                var _url = "/Purchase/VerifyMoldNumber?PartNumber="+PartNumber;
                $.ajax({
                    url:_url,
                    type:"Get",
                    success:function(msg){
                        if (msg!=""){
                            $("#MoldNumber").val(msg);
                            $("#VerifyFail").val(0);
                        }else{
                            $("#MoldNumber").val("");
                            alert("未找到零件对应模具号");
                            $("#VerifyFail").val(1);
                        }
                    }
                })
            }else{
                $("#VerifyFail").val(0);
            }
        }else{
            alert("零件号长度必须为9位");
        }
    }

    function ShowRequireDateSet(){

        $("#RequireDateVal").val("");
        $("#RequireDateModal").modal("show");
    }

    function SaveRequireDate(RequireDate){
        var selrows = $("#PRContentGrid").jqGrid('getGridParam', 'selarrrow');

        if (selrows.length>0){
            for (i=0;i<selrows.length;i++){
                $("#PRContentGrid").jqGrid('setCell', selrows[i], 'RequireTime', RequireDate);
            }
        }else{
            var _rows =  $('#PRContentGrid').getDataIDs();
            for (i=0;i< _rows.length;i++){
                //$("#PRContentGrid").jqGrid('setCell', i+1, 'RequireTime', RequireDate);
                $("#PRContentGrid").setCell(_rows[i], 'RequireTime', RequireDate);
            }
        }


    }

    function SetDefaultDate(){
        var _typeID=Number($("#PurchaseType").val());
        if (_typeID!=0){
            //var _url = "/Purchase/GetPurchaseTypeInfo?PurchaseTypeID="+_typeID;
            //$.ajax({
            //    url:_url,
            //    type:"Get",
            //    success:function(msg){
            //        var _defaultPeriod = Number(msg.DefaultPeriod);
            //        var _curDate = new Date();
            //        _curDate.setDate(_curDate.getDate()+_defaultPeriod);
            //        var _defaultDate = _curDate.getFullYear()+"-0"+(_curDate.getMonth()+1)+"-"+_curDate.getDate();

            //        SaveRequireDate(_defaultDate);
            //    }
            //})
            $.get('/Purchase/Service_GetPRMRDate?_purchaseTypeID='+_typeID,function(res){
                //SaveRequireDate(_defaultDate);
                $('#RequireDateVal').val(res);
                SaveRequireDate( res);
            })
        }
    }

    //查询零件
    function PartSearch(){
        var _key = $("#SpecKeyword").val();
        var _sel=$('#_sel').val();
        var _selPartModal=$('#_selPartModal').val();
        var _url = "/Part/Service_Json_GetPartByKeys?sel=" + _sel + "&Keywords=" + _key+'&_selPartModal='+_selPartModal;
        reloadGrid(_url,'tb_PartSearch');
        //var _url = "/Part/QueryBySpec?Keyword="+_key;
        //var _row = "";
        //$("#AllParts").removeAttr("style");
        //$("#PartList tr").remove();
        //$.getJSON(_url, function(msg){
        //    $.each(msg, function(i, n){
        //        _row = "<tr><td>"+n.PartNumber+"</td><td>"+n.Specification+"</td><td>"+n.MaterialName+"</td><td>"+n.Version+"</td><td>"+
        //            "<button class='btn btn-primary' id='"+n.PartID+"' onclick='AddPart("+n.PartID+")'>添加</button>"+
        //            "</td></tr>";
        //        $("#PartList").append(_row);
        //    })
        //})
    }
    function reloadGrid(_url,_tbID){
        //var _url = '/Task/JsonMachineTasks?MoldNumber=' + _MoldNumber + "&TaskType=" + _TaskType + "&State=" + _State+"&Keyword="+Keyword;
        $('#'+_tbID).jqGrid('setGridParam', { datatype: 'json', url: _url }).trigger("reloadGrid");
    }

    //添加至表格
    function AddPart(PartID){
        var _url = "/Part/JsonPart?PartID="+PartID;
        $.getJSON(_url, function(msg){
            var _tempID = Number($("#tempID").val())- 1;
            $("#tempID").val(_tempID);
            var _moldNumber = msg.Name.substring(0,msg.Name.indexOf('_'))
            data = {
                ID: "",
                PartID:PartID,
                Name: msg.ShortName,
                Quantity: msg.Quantity,
                PartNumber: msg.PartNumber,
                Material:  msg.MaterialName,
                Hardness: msg.Hardness,
                Specification: msg.Specification,
                BrandName: msg.BrandName,
                SupplierName: msg.SupplierName,
                JobNo:msg.JobNo,
                Memo: "",
                State:"",
                RequireTime: "",
                MoldNumber:_moldNumber,
                ERPPartID:msg.ERPPartID,
                PlanQty:msg.TotalQty
            };
            $("#PRContentGrid").addRowData(_tempID, data, 0, 0);
        })
    }
    //添加至表格
    function AddPartByPartNum(PartNum){
        var _url = "/Part/Service_Part_GetPartByPartNum?_partNum="+PartNum;
        $.getJSON(_url, function(msg){
            var _tempID = Number($("#tempID").val())- 1;
            $("#tempID").val(_tempID);            
            var _partNums=(msg.PartNum).split('-');
            data = {
                ID: "",
                PartID:0,
                Name: msg.PartName,
                Quantity: msg.PlanQty,
                PartNumber: msg.PartNum,
                Material:  msg.Materials,
                Hardness: '',
                Specification: msg.Specification,
                BrandName: '',
                SupplierName: '',
                JobNo:_partNums[1],
                Memo: "",
                State:"",
                RequireTime: "",
                MoldNumber:msg.MoldNumber,
                ERPPartID:'',
                PlanQty:msg.PlanQty,
            };
            $("#PRContentGrid").addRowData(_tempID, data, 0, 0);
        })
    }

    function AddPartNormal(){
        //var rowData=$('#').
        var selr = $('#tb_PartSearch').jqGrid('getGridParam', 'selarrrow');
        console.log(selr);
        for (var i = 0; i < selr.length; i++) {
            var rowData = $("#tb_PartSearch").jqGrid('getRowData', selr[i]);
            console.log(rowData);
            var _tempID = Number($("#tempID").val())- 1;
            $("#tempID").val(_tempID);
            data = {
                ID: "",
                PartID:rowData.PartID,
                Name: rowData.Name,
                Quantity: rowData.Quantity,
                PartNumber: rowData.PartNumber,
                Material:  rowData.MaterialName,
                Hardness: rowData.Hardness,
                Specification: rowData.Specification,
                BrandName: rowData.BrandName,
                SupplierName: '',
                JobNo:rowData.JobNo,
                Memo: rowData.Memo,
                State:"",
                RequireTime: "",
                MoldNumber:rowData.MoldNum,
                ERPPartID:rowData.ERPPartID,
                PlanQty:rowData.PlanQty
            };
            $("#PRContentGrid").addRowData(_tempID, data, 0, 0);
        }       
    }

    function NewPart(){
        $("#PartSearch").modal("hide");
        $("#PRContentAdd input").val("");
        $("#PRContentAdd select").val(0);
        LoadBrands();
        showBrand('');
        $("#row").val(0);
        $("#PRContentAdd").modal("show");
    }

    function LoadCostCenters(){
        var _url ="/Purchase/JsonCostCenters";
        $("#CostCenterID option").remove();
        $.getJSON(_url, function(msg){
            $("#CostCenterID").append($("<option/>",{
                value:0,
                text:'-'
            }))
            if(sessionStorage['SpecKey'] == 'hr'){
                $.each(msg, function(i,n){
                    //if(n.Name=='项目部'){
                        $("#CostCenterID").append($("<option/>",{
                            value:n.CostCenterID,
                            text:n.Name
                        }))
                    //}
                    
                })
            }else{               
                $.each(msg, function(i,n){

                    //$("#CostCenterID").append($("<option/>", {value:n.CostCenterID, text:n.Name}));
                    $("#CostCenterID").append($("<option/>",{
                        value:n.CostCenterID,
                        text:n.Name
                    }))
                })
            }           
        })
    }

    function RemoveCancelItems(){
        var selr = $('#PRContentGrid').jqGrid('getGridParam', 'selarrrow');
        if(selr.length==0){
            alert("请选择要删除的申请项");
        }else{
            var cancelItemName="";
            var _ids="";
            for (var i = 0; i < selr.length; i++) {
                var stateText = $("#PRContentGrid").getCell(selr[i], "State");
                if (stateText!="订单取消"){
                    var _name = $("#PRContentGrid").getCell(selr[i], "Name")
                    cancelItemName= cancelItemName==""?_name:cancelItemName+","+_name;
                }else{
                    var _id =  $("#PRContentGrid").getCell(selr[i], "ID");
                    _ids = _ids==""?_id:_ids+","+_id;
                }
                if (cancelItemName!=""){
                    alert("只有处于订单取消状态的申请项才允许删除")
                }else{
                    RemovePOCancelItems(_ids);
                }
            }
        }

    }

    function RemovePOCancelItems(IDs){
        var _url = "/Purchase/RemovePOCancelItems?PRContentIDs="+IDs+"&PurchaseRequestID="+$("#PurchaseRequestID").val();
        $.ajax({
            url:_url,
            type:"Get",
            success:function(msg){
                alert(msg);
                location.reload();
            }
        })
    }
    $("#CostCenterBatch").on('click', function(){
        $("#CostCenterModal").modal("show")
    })
    $("#CostCenterModal").on("shown.bs.modal", function(){
        LoadCostCenters()
    })
    $("#SetCostCenter").on('click', function(){
        SetCostCenter();
    })
    function SetCostCenter(){
        var selrows = $("#PRContentGrid").jqGrid('getGridParam', 'selarrrow');
        if (selrows.length==0){
            selrows=  $('#PRContentGrid').getDataIDs();
        }
        var _text = $("#CostCenterID option:selected").text();
        var _val = $("#CostCenterID option:selected").val();
        _text=_text=='-'?' ':_text;
        for (i=0;i<selrows.length;i++){
            $("#PRContentGrid").setCell(selrows[i], "CostCenterName", _text);
            $("#PRContentGrid").setCell(selrows[i], "CostCenterID", _val);
        }
        //$("#CostCenterModal").modal('hide')
    }
    function SetPurchaseType(){
        var selrows = $("#PRContentGrid").jqGrid('getGridParam', 'selarrrow');
        if (selrows.length==0){
            selrows=  $('#PRContentGrid').getDataIDs();
        }
        //var _text = $("#CostCenterID option:selected").text();
        var _val = $("#PurchaseType option:selected").val();
        //_text=_text=='-'?' ':_text;
        for (i=0;i<selrows.length;i++){
            //$("#PRContentGrid").setCell(selrows[i], "CostCenterName", _text);
            $("#PRContentGrid").setCell(selrows[i], "PurchaseType", _val);
        }
    }
    function SetSupplier(){
        var selrows = $("#PRContentGrid").jqGrid('getGridParam', 'selarrrow');
        if (selrows.length==0){
            selrows=  $('#PRContentGrid').getDataIDs();
        }
        //var _text = $("#SupplierID option:selected").text();
        //var _val = $("#SupplierID option:selected").val();
        var _suppliername=$('#SupplierName').val();
        for (i=0;i<selrows.length;i++){
            $("#PRContentGrid").setCell(selrows[i], "SupplierName", _suppliername);
        }
    }

    //function SupplierListImport(_suplistID){
    //    var js='';
    //    $('#'+_suplistID).html('');
    //    $.get('/Purchase/JsonSuppliersByJS?js='+js,function(res){
    //        console.log(typeof(res));
    //        var fo=res.toString();
    //        fo=fo.split(",");
    //        for(var i=0;i<fo.length;i++){
    //            //中文
    //            var v1=fo[i].split('-')[0];
    //            //英文
    //            var v2=fo[i].split('-')[1];
    //            var ohtml = "<option value='"+v1+"'>"+v2+"</option>";
    //            var $ohtml = $(ohtml);
    //            $('#'+_suplistID).append($ohtml);
    //        }
    //    });
    //}

    //加载workshop对应部门人员
    function LoadWSUser(type) {
        $("#wsUserID option").remove();
        var _depName='';
        switch(type){
            case 1:
                _depName='CNC';
                break;
            case 2:
                _depName='EDM';
                break;
            case 3:
                _depName='WEDM';
                break;
            case 4:
                _depName='CNC';
                break;
            case 6:
                _depName='MG';
                break;
        }
        $.getJSON("/User/GetUsersByDepartment?DepartmentName="+_depName, function (msg) {
            $.each(msg, function (i, n) {
                $("#wsUserID").append($("<option/>", {
                    value: n.UserID,
                    text: n.FullName
                }))
            })
        })
    }

    function _wfViewConfig(type){
        if(type>0){
            //表格列头
            //$("#PRContentGrid").setGridParam().showHideCol("Operater");
            //$("#PRContentGrid").setGridParam().showHideCol("MachineName");
            //返回相应按钮
            $('#AddContent').hide();
            $('#brandtr').hide();
            //$('#Brand').hide();
            //$('#Brand').val('委外');
            //申请人
            $('#ApprovalUserID').attr('disabled',true);
            //供应商
            $('#SupplierName').attr('readonly',true);
        }
        else{
            $("#PRContentGrid").setGridParam().showHideCol("BrandName");
            //$('#brandtr').show();
        }
    }
</script>

<script>
    $(document).ready(function(){
        PurchaseItemAttachFileGird();//初始化采购项附件列表

        $('#ShowAttachFileModal').on('click',function(){
            ReloadPurchaseItemGrid();
            $('#Files').val("");
            $('#PurchaseItemFileDialog').modal("show");
        })

        $('#modal_PurchaseItemAttachSubmitbtn').on('click',function(){
            if ($('#Files').val() == '') {
                alert('请选择上传表单！');
                $('#Files').val('');
                return false;
            }
            var _items=GetItemIDs();
            $('#_itemIDs').val(_items);
            $('#modal_PurchaseItemAttachForm').ajaxSubmit({
                url: '/Attachment/Service_PurchaseItemFileUpload/',
                type: 'post',
                async:false,
                dataType: 'json',
                success: function (msg) {
                    if (msg.Code == 1) {
                        $('#Files').val("");
                        ReloadPurchaseItemGrid();
                    }
                    else
                        alert(msg.Message);
                }
            })
        })

        $('#modal_sel_purFileModal').on('change',function(){
            var _sel=$('#modal_sel_purFileModal').val();
            if(Number(_sel)==1){//单附件
                //alert('1');
                $('#Files').removeAttr('multiple');
            }else{
                //alert('2');
                $('#Files').attr('multiple','multiple');
            }
        })
    })

    function ReloadPurchaseItemGrid(){
        var _items=GetItemIDs();
        _url='/Attachment/Service_GetFilesByPurchaseItem?_itemIDs='+_items;
        $('#modal_tb_PurchaseItemFiles').jqGrid('setGridParam', { datatype: 'json', url: _url }).trigger("reloadGrid");
    }

    function DeleteAttach(ObjID,ObjType,FileName,FileType){
        $.ajaxSettings.async = false;//同步请求
        $.get('/Attachment/Service_DelAttach?ObjID='+ObjID+'&ObjType='+ObjType+'&FileName='+FileName+'&FileType='+FileType,function(res){
            if(res.Code==-1){
                alert('只允许上传附件本人删除！');
                return false;
            }
            else
                ReloadPurchaseItemGrid(ObjID);           
        })
    }

    function DownloadAttach(ObjID,ObjType,FileName,FileType){
        $.ajaxSettings.async = false;//同步请求
        $.get('/Attachment/Service_FileDownLoad?ObjID='+ObjID+'&ObjType='+ObjType+'&FileName='+FileName+'&FileType='+FileType)
    }

    function GetItemIDs(){
        var selrows = $("#PRContentGrid").jqGrid('getGridParam', 'selarrrow');
        var _items='';
        if (selrows.length==0){
            selrows=  $('#PRContentGrid').getDataIDs();
        }
        for (i=0;i<selrows.length;i++){
            var _id=$('#PRContentGrid').getCell(selrows[i], "PurchaseItemID");
            _items=_items+_id+',';
        }
        _items=_items.substring(0,_items.length-1);
        return _items;
    }
</script>

<script>
    $(function() {
        $(document).tooltip();       

        $('#BKClass').on('blur',function(){
            $.get('/Purchase/Service_GetBKJonNo?_bkClass='+$('#BKClass').val(),function(res){
                $('#JobNo').val(res);
            });
        });

        $('#PurchaseType').on('click',function(){
            var _selpurTypetxt=$('#PurchaseType option:selected').text();
            $('#PurchaseTypeName').val(_selpurTypetxt);
            if($('#PurchaseType').val()>0){
                $('#AddContent').removeAttr('disabled');
            }else{
                $('#AddContent').attr('disabled','disabled');
            }
            _webPurTypeIntialConfig();
        });

        $('#PRContentAdd').on('shown.bs.modal',function(){        
            var row=$('#PRContentID').val();//$("#row").val();
            $('#Specification').attr('readonly','readonly'); 
            if (row == 0) {//新增  
                $('#MoldNum').removeAttr('readonly');
                $('#HCClass').removeAttr('readonly');
                $('#BKClass').removeAttr('readonly');
                $('#JobNo').removeAttr('readonly');
            }else{//编辑
                $('#MoldNum').attr('readonly','readonly');
                $('#HCClass').attr('readonly','readonly');
                $('#BKClass').attr('readonly','readonly');
                $('#JobNo').attr('readonly','readonly');                
            }
            var _selPartModal=Number($('#_selPartModal').val());
            $('#modal_HCClassList').empty();
            $('#modal_BKClassList').empty();
            switch(_selPartModal){
                case 1://直接材料
                    $('#tr_PlanQty').hide();
                    $('#PlanQty').hide();
                    $('._selPart1').show();
                    $('._selPart2').hide();
                    $('._selPart5').hide();
                    break;
                case 2://耗材
                    $('#tr_PlanQty').show();
                    $('#PlanQty').show();
                    if (row == 0){
                        $('#PlanQty').removeAttr('readonly');
                    }else{
                        $('#PlanQty').attr('readonly','readonly');
                    }
                    $('#JobNo').attr('readonly','readonly');
                    $('._selPart1').hide();
                    $('._selPart2').show();
                    $('._selPart5').hide();   
                    HCClassImport();
                    break;
                case 5://备库
                    $('#tr_PlanQty').show();
                    $('#PlanQty').show();
                    if (row == 0){
                        $('#PlanQty').removeAttr('readonly');
                    }else{
                        $('#PlanQty').attr('readonly','readonly');
                    }

                    $('._selPart1').hide();
                    $('._selPart2').hide();
                    $('._selPart5').show(); 
                    $('#JobNo').attr('readonly','readonly');
                    BKClassImport();
                    break;
                default:
                    $('._selPart1').show();
                    $('._selPart2').hide();
                    $('._selPart5').hide();
                    break;
            } 
        });

        $('#PartSearch').on('shown.bs.modal',function(){
            _webPurTypeIntialConfig();
        })

        $('#HCClass').on('change',function(){
            GetJobNo();
        });
        $('#BKClass').on('change',function(){
            GetJobNo();
        });
        ////
        LoadMoldNum();

        $('#MoldNum').on('blur',function(){
            $('#MoldNumber').val($('#MoldNum').val());
            GetMoldJobNo();
        });

        $('#JobNo').on('blur',function(){
            var _prid=$("#PRContentID").val();
            var moldNum='';
            var _selPartModal = Number($('#_selPartModal').val());
            switch (_selPartModal) {
                case 1:
                    moldNum = $('#MoldNum').val();
                    break;
                case 2:
                    moldNum = $('#HCClass').val();
                    break;
                case 3:
                    moldNum = $('#MoldNum').val();
                    break;
                case 5:
                    moldNum = $('#BKClass').val();
                    break;
                default:
                    moldNum = $('#MoldNum').val();
                    break;
            }
            if(_prid==0){
                if(moldNum!='' && moldNum!=undefined){
                    var _partnumber=moldNum+'-'+$('#JobNo').val();
                    $.get('/Part/Service_Part_GetByPartNum?_partNum='+_partnumber,function(res){
                        if(res.PartID>0){
                            $('#PartNumber').val(res.PartNumber);
                            $('#Name').val(res.Name);
                            $('#PartID').val(res.PartID);
                            $('#Quantity').val(res.Quantity);
                            $('#Specification').val(res.Specification);
                            $('#MaterialID').val(res.MaterialID);
                            $('#HardnessID').val(res.Hardness);
                            $('#Brand').val(res.BrandID);
                            $('#AvailableSuppliers').val(res.SupplierName);

                            $('#Specification').attr('readonly','readonly');
                        }else{
                            //CLearPartForm();
                            $('#PartID').val(0);
                            $('#Quantity').val(0);
                            $('#Specification').removeAttr('readonly');
                        }
                    });
                }
                else{
                    alert('请先输入模号！');
                    $('#MoldNum').val('');
                    $('#HCClass').val('');
                    $('#BKClass').val('');
                    $('#JobNo').val('');
                }
            }  
        });

        //采购申请单同步标记
        $('#PRSyncFlagBtn').on('click',function(){
            var _prId=$('#PurchaseRequestID').val();
            if(confirm('确认标记？')){
                $.get('/Purchase/Service_PR_SyncFlag?prID='+_prId,function(){
                    alert('操作成功！');
                    window.location='/Purchase/Index';
                });
            }
        })
    });
    function HCClassImport() {
        $.get('/Warehouse/Service_GetHCClassList', function (res) {
            $.each(res,function(i,n){
                var ohtml = "<option value='" + n.Code + "'>" + n.Name + "</option>";
                var $ohtml = $(ohtml);
                $('#modal_HCClassList').append($ohtml);
            })
        })
        //var ohtml = "<option value='123'>456</option>";
        //var $ohtml = $(ohtml);
        //$('#modal_HCClassList').append($ohtml);
    }
    function BKClassImport(){
        $.get('/Warehouse/Service_GetBKClassList', function (res) {
            $.each(res,function(i,n){
                var ohtml = "<option value='" + n.Code + "'>" + n.Name + "</option>";
                var $ohtml = $(ohtml);
                $('#modal_BKClassList').append($ohtml);
            })
        })
        //var ohtml = "<option value='123'>456</option>";
        //var $ohtml = $(ohtml);
        //$('#modal_BKClassList').append($ohtml);
    }
    function _webPurTypeIntialConfig(){
        var _purtype = Number($('#PurchaseType').val());
        var _purtypeName = $('#PurchaseTypeName').val();
        var _selPartModal=0;
        var _selPartModalTxt='';

        $.ajaxSettings.async=false;
        $.get('/Purchase/GetParentPurchaseTypeInfo?PurchaseTypeID='+_purtype,function(res){
            switch(res.Name){
                case '模具直接材料':
                    _selPartModal=1;
                    _selPartModalTxt='模具直接材料';
                    $('#NewPart').removeAttr('disabled');
                    break;
                case '模具委外加工':
                    _selPartModal=3;
                    _selPartModalTxt='模具委外加工';
                    $('#NewPart').attr('disabled','disabled');
                    break;
                case '模具耗材':
                    if (_purtypeName == "生产耗材") {
                        _selPartModal=2;
                        _selPartModalTxt='生产耗材';
                        $('#NewPart').removeAttr('disabled');
                    }else{ //if(_purtypeName == "模具耗材备库"){
                        _selPartModal=5;
                        _selPartModalTxt='耗材备库';
                        $('#NewPart').removeAttr('disabled');
                    }                
                    break;
            };            
        });
        $('#_selPartModal').val(_selPartModal);
        $('#_selPartModalTxt').val(_selPartModalTxt);
        $('#JobNo').removeAttr('readonly');
    }

    function GetJobNo(){
        var _text;
        var _selPartModal = Number($('#_selPartModal').val());
        switch (_selPartModal) {
            //case 1:
            //    _text = $('#MoldNum').val();
            //    break;
            case 2:
                _text = $('#HCClass').val();
                break;
            case 5:
                _text = $('#BKClass').val();
                break;
        }
        $.ajaxSetup({  
            async : false  
        }); 
        if(_text!='' && _text!=undefined && _text!=null){
            $.get('/WareHouse/Service_WH_GetPartNumByType?_type='+_text,function(res){
                var _strs=res.split('-');
                $('#JobNo').val(_strs[1]);
                $('#PartNumber').val(res);
            });
        }else{
            alert('类型无效！');
            $('#SaveStockItem').attr('disabled','disabled');
        }     
    }

    function LoadMoldNum(){
        $('#modal_MoldNum').html('');
        $.get('/Part/Service_Get_MoldNumList',function(res){
            $.each(res,function(i,n){
                var ohtml = "<option value='" + n + "'>" + n + "</option>";
                var $ohtml = $(ohtml);
                $('#modal_MoldNum').append($ohtml);
            })
        })
    }

    function GetMoldJobNo(){
        $('#modal_JobNoList').html('');
        $.get('/Part/Service_Part_GetJobNo?MoldNum='+$('#MoldNum').val(),function(res){
            $.each(res,function(i,n){
                var ohtml = "<option value='" + n + "'>" + n + "</option>";
                var $ohtml = $(ohtml);
                $('#modal_JobNoList').append($ohtml);
            })
        })
    }

    function CLearPartForm(){
        $('#PartNumber').val('');
        $('#Name').val('');
        $('#PartID').val(0);
        $('#Quantity').val(0);
        $('#Specification').val('');
        $('#MaterialID').val('');
        $('#HardnessID').val('');
        $('#Brand').val('');
        $('#AvailableSuppliers').val('');
    }
</script>